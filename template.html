<style>
    #openseadragon {
        height: 60vh;
        background-color: #000000;
    }
    #answer-column {
        overflow-y: auto;
    }
    .highlight {
        outline: 9999px rgba(0,0,0,.6) solid;
    }
    .hud,
    .tooltip.tooltip-hud .tooltip-inner {
        background-color: rgba(0, 0, 0, 0.5);
    }
    .hud {
        position: absolute;
        z-index: 2;
        border-radius: 2.5rem;
    }
    .btn-hud {
        background: none;
        color: #fff;
        opacity: 0.65;
        text-shadow: 0 0 5px #000;
        font-size: 1.25rem;
        padding: .5rem;
    }
    .btn-hud:hover,
    .btn-hud:focus {
        opacity: 1;
    }
    .tooltip.tooltip-hud .tooltip-inner:before {
        border-right-color: rgba(0, 0, 0, 0.5);
    }
    @media (min-width: 768px) {
        #openseadragon {
            height: 100%;
        }
    }
</style>

<div id="project-content" class="bg-faded container-fluid d-flex flex-column h-100">
    <div class="row h-100">

        <!-- Viewer column -->
        <div class="col-sm-12 col-md-9 px-0">
            <div class="hud ml-2 mt-2 d-flex flex-column">
                <button id="zoom-in" class="btn btn-hud" data-toggle="tooltip" role="button">
                    <span class="fa fa-plus-circle"></span>
                </button>
                <button id="zoom-out" class="btn btn-hud" data-toggle="tooltip" role="button">
                    <span class="fa fa-minus-circle"></span>
                </button>
                <button id="home" class="btn btn-hud" data-toggle="tooltip" role="button">
                    <span class="fa fa-refresh"></span>
                </button>
                <button id="full-page" class="btn btn-hud" data-toggle="tooltip" role="button">
                    <span class="fa fa-expand"></span>
                </button>
                <button id="image-quality" class="btn btn-hud" data-toggle="tooltip" title="Image quality" role="button">
                    <span class="fa fa-cog"></span>
                </button>
            </div>
            <div id="openseadragon"></div> 
        </div>

        <!-- Question and answer column -->
        <div id="answer-column" class="col-sm-12 col-md-3 py-3">
            <div class="card card-block text-left mb-2">
                <p id="question" class="lead"></p>
                <form id="answer-form">
                    <fieldset>
                    </fieldset>
                </form>
                <hr class="w-100 mt-2">
                <div id="ocr" class="text-center">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <p class="ocr-status text-muted mt-1 mb-0"></p>
                </div>
            </div>
            <div class="text-center">
			    <button class="btn btn-success btn-sm btn-answer mt-2" role="button"><span class="fa fa-floppy-o mr-1"></span>Save</button>
                <hr>
                <p class="mt-2 mb-1">
                    <span class="fa-stack mr-1">
                      <i class="fa fa-circle fa-stack-2x"></i>
                      <i class="fa fa-trophy fa-stack-1x fa-inverse"></i>
                    </span><span id="rank"></span>
                    <span class="fa-stack ml-3 mr-1">
                      <i class="fa fa-circle fa-stack-2x"></i>
                      <i class="fa fa-tasks fa-stack-1x fa-inverse"></i>
                    </span><span id="score"></span>
                </p>
                <p class="mb-0"><small>You are working on task #<span id="task-id"></span></small></p>
            </div>
        </div>
    </div>
</div>



<script>
    /**
     * A class to hadle OCR.
     */
    class OCR {
    
        constructor(imageArk, coords, fields) {
            this.fields = fields;
            this.region = `${coords.x},${coords.y},${coords.width},${coords.height}`;
            this.url    = `http://api.bl.uk/image/iiif/${imageArk}/${this.region}/full/0/default.jpg`;
        }
    
        reset() {
            $('#ocr .ocr-result').remove('');
            $('#ocr .ocr-copy').remove();
            $('#ocr .progress-bar').removeClass('hidden-xs-up');
        }
    
        _handleProgress(p) {
            $('#ocr .ocr-status').html(p.status);
            if (p.status == 'recognizing text') {
                $('#ocr .progress-bar').css('width', `${p.progress * 100}%`);
            }
        }
    
        _handleResult(r) {
            $('#ocr .ocr-status').html('');
            $('#ocr .progress-bar').addClass('hidden-xs-up');
            $('#ocr').append(`<p class="ocr-result mb-3">${r.text}</p>`);
            for (let f of this.fields) {
                $('#ocr').append(
                    `<button class="btn btn-secondary btn-sm ocr-copy btn-block" data-text="${r.text}" data-target="#${f.id}" role="button">
                    Copy to ${f.label}
                    </button>`
                );
            }
        }
    
        performOcr() {
            Tesseract.recognize(this.url)
                .progress(p => this._handleProgress(p))
                .catch(err => notify(err.message, 'error'))
                .then(r => this._handleResult(r))
        }
    }
    
    // Setup viewer
    OpenSeadragon.setString("Tooltips.FullPage", "Fullscreen");
    OpenSeadragon.setString("Tooltips.Home", "Reset zoom");
    const viewer = OpenSeadragon({
        id: "openseadragon",
        prefixUrl: "/static/img/openseadragon/",
        zoomInButton:   "zoom-in",
        zoomOutButton:  "zoom-out",
        homeButton:     "home",
        fullPageButton: "full-page",
        showNavigator: true,
        navigatorPosition: 'BOTTOM_RIGHT',
        homeFillsViewer: true,
        minZoomLevel: 0.1,
        showReferenceStrip: true,
        referenceStripScroll: 'vertical',
        gestureSettingsMouse: {
            clickToZoom: false
        },
        gestureSettingsTouch: {
            clickToZoom: false
        },
        gestureSettingsPen: {
            clickToZoom: false
        }
    });
    
    // Setup tooltips
    $('.btn-hud[data-toggle="tooltip"]').tooltip({
        placement: 'right',
        template: `<div class="tooltip tooltip-hud" role="tooltip"><div class="tooltip-arrow"></div>
                  <div class="tooltip-inner"></div></div>`
    });

    /**
     * Load an image into the viewer.
     */
    function loadImage(imageArk) {
        const url = `http://api.bl.uk/image/iiif/${imageArk}/full/full/0/default.jpg`;
        const size = '100';
        viewer.open({
            type: 'image',
            url:  url,
            buildPyramid: false
        });
    }
    
    /**
     * Load the user's rank and score.
     * Assumes that the current user's name has been added to currentUserName before this template was rendered.
     */
    function loadUserProgress() {
        if (!currentUserName) {
            return
        }
        $.ajax({
            url: '/leaderboard/',
            dataType: 'json',
            contentType: 'application/json',
            data: '{}'
        }).done(function(data) {
            for (let user of data.top_users) {
                if (user.name == currentUserName) {
                    $('#rank').append(user.rank);
                    $('#score').html(user.score);
                }
            }
        });
    }

    /**
     * Draw an overlay from a selection.
     */
    function drawOverlay(s) {
        let elem   = document.createElement("div"),
            vpRect = viewer.viewport.imageToViewportRectangle(s);
        elem.className = 'highlight';
        let overlay = {
            element: elem,
            location: new OpenSeadragon.Rect(vpRect.x, vpRect.y, vpRect.width, vpRect.height, vpRect.degrees)
        }
        viewer.viewport.fitBounds(overlay.location);
        viewer.addOverlay(overlay);
    }
    
    /**
     * Generate an answer form.
     */
    function generateForm(fields) {
        $('#answer-form fieldset').html('');
        for (let f of fields) {
            $('#answer-form fieldset').append(
                `<div class="form-group">
                <label class="card-label" for="${f.id}">${f.label}</label>
                <input class="form-control" id="${f.id}" name="${f.id}" placeholder="${f.placeholder}" type="${f.type}">
                </div>`
            );
        }
        $('#answer-form input:first').focus();
    }
    
    /**
     * Handle click of an OCR copy button.
     */
    $('#ocr').on('click', '.ocr-copy', function() {
        const target = $(this).data('target'),
              text   = $(this).data('text');
        $(target).val(text);
    });

    /**
     * Handle a faliure to open an image
     */
    viewer.addHandler('open-failed', function(evt) {
        notify(evt.message, 'error');
    });

   /**
    * Load the task.
    */
    pybossa.taskLoaded(function(task, deferred) {
        deferred.resolve(task);
    });

    /**
     * Present the task.
     */
    pybossa.presentTask(function(task, deferred) {
        if (!$.isEmptyObject(task)) {
            const recordURL = `http://primocat.bl.uk/F/?func=direct&doc_number=${task.info.aleph_sys_no}`,
                  coords    = JSON.parse(task.info.coordinates),
                  fields    = JSON.parse(task.info.fields),
                  rect      = new OpenSeadragon.Rect(coords.x, coords.y, coords.width, coords.height, coords.degrees),
                  ocr       = new OCR(task.info.image_ark, coords, fields);
            $('#record_url').html();
            $('#task-id').html(task.id);
            $('#help').html(task.info.help);
            $('#question').html(task.info.question);
            loadImage(task.info.image_ark);
            ocr.reset();
            ocr.performOcr();
            generateForm(fields);
            loadUserProgress();
            
            viewer.addHandler('tile-loaded', function() {
                drawOverlay(rect);
            });
            

            $('.btn-answer').off('click').on('click', function() {
                task.answer = {
                    category: task.info.category,
                    image_ark: task.info.image_ark,
                    lark: task.info.ldark,
                    color: task.info.color,
                    aleph_sys_no: task.info.aleph_sys_no,
                    coordinates: coords,
                };

                console.log(JSON.stringify(task.answer, null, 2));

                pybossa.saveTask(task.id, task.answer).done(function() {
                    deferred.resolve();
                    notify('Answer saved, thanks!', 'success');
                }).fail(function(xhr, status, error) {
                    logError(new Error(error));
                });
            });
        } else {
          $("#project-content").hide();
          notify('Congratulations! You have contributed to all available tasks!', 'success');
        }
    });
    pybossa.run('project-playbills-transcribe');
</script>